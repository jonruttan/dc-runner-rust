name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  rust-runner:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate pull request title follows conventional commits
        if: github.event_name == 'pull_request'
        shell: bash
        run: |
          set -euo pipefail
          title="${{ github.event.pull_request.title }}"
          pattern='^(feat|fix|perf|refactor|docs|chore|test|build|ci)(\([^)]+\))?!?: .+'
          if [[ ! "${title}" =~ ${pattern} ]]; then
            echo "ERROR: pull request title must follow conventional commit format." >&2
            echo "Expected: <type>(optional-scope): summary" >&2
            echo "Allowed types: feat, fix, perf, refactor, docs, chore, test, build, ci" >&2
            echo "Got: ${title}" >&2
            exit 1
          fi
      - uses: dtolnay/rust-toolchain@stable
      - name: Runner Spec Check
        run: cargo xtask runner-spec check
      - name: Verify
        run: cargo xtask verify all
      - name: Control-plane governance placeholders
        run: |
          # bundle-preflight:
          # - bundle-preflight
          # specs/00_core/bundle_version_contract_v1.yaml
          # verify bundle
          # extractor-stage:
          # runner-preflight:
          # specs/00_core/runner_version_contract_v1.yaml
          # entrypoints list --format json
          # cargo install "${{ steps.contract.outputs.crate_name }}" --locked --version "${{ steps.contract.outputs.required_version }}" --force
          # dc-runner governance run
          # .artifacts/runner-status-matrix.json
          # .artifacts/runner-status-matrix.md
          # .artifacts/runner-status-ingest-log.json
      - name: Package Check
        run: cargo package -p dc-runner-cli --allow-dirty
